{% extends "layout.html" %} {% block content %}
<div class="d-flex justify-content-between p-4">
    <h2>Gestión de Proyectos</h2>
    <button
        class="btn btn-primary"
        onclick="openOportunidadModal()"
        data-bs-toggle="modal"
        data-bs-target="#nuevaOportunidadModal"
    >
        <i data-feather="plus"></i> Nueva Oportunidad
    </button>
</div>

<!-- Modal para Nueva Oportunidad -->
<div class="modal fade" id="nuevaOportunidadModal" tabindex="-1" aria-labelledby="nuevaOportunidadModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="nuevaOportunidadModalLabel">Nueva Oportunidad</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="nuevaOportunidadForm">
                    <div class="mb-3">
                        <label for="cuenta" class="form-label">Cuenta</label>
                        <select class="form-select" id="cuenta" name="cuenta" required>
                            <option value="">Seleccionar cuenta</option>
                            {% for aliado in aliados.values() %}
                            <option value="{{ aliado.id }}">{{ aliado.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="nombre" class="form-label">
                            Nombre 
                            <span class="text-muted" data-bs-toggle="tooltip" data-bs-placement="top" title="Business Problem">
                                <i data-feather="help-circle" style="width: 16px; height: 16px;"></i>
                            </span>
                        </label>
                        <input type="text" class="form-control" id="nombre" name="nombre" required 
                               placeholder="Describe el problema de negocio">
                    </div>
                    
                    <div class="mb-3">
                        <label for="descripcion" class="form-label">
                            Descripción 
                            <span class="text-muted" data-bs-toggle="tooltip" data-bs-placement="top" title="Iniciativa Analítica">
                                <i data-feather="help-circle" style="width: 16px; height: 16px;"></i>
                            </span>
                        </label>
                        <textarea class="form-control" id="descripcion" name="descripcion" rows="3" required
                                  placeholder="Describe la iniciativa analítica propuesta"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="impacto" class="form-label">
                            Impacto 
                            <span class="text-muted" data-bs-toggle="tooltip" data-bs-placement="top" title="Impacto de negocio esperado (decisiones)">
                                <i data-feather="help-circle" style="width: 16px; height: 16px;"></i>
                            </span>
                        </label>
                        <textarea class="form-control" id="impacto" name="impacto" rows="3" required
                                  placeholder="Describe el impacto de negocio esperado y las decisiones que se tomarán"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="submitOportunidad()">Crear Oportunidad</button>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid px-4">
    <div
        class="row mb-4"
        style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem"
    >
        <div>
            <div class="card bg-light h-100">
                <div class="card-body">
                    <h5 class="card-title text-primary">Oportunidad</h5>
                    <h2 class="card-text mb-0">
                        {{ estados.oportunidad|length }}
                    </h2>
                    <small class="text-muted">Proyectos</small>
                </div>
            </div>
        </div>
        <div>
            <div class="card bg-light h-100">
                <div class="card-body">
                    <h5 class="card-title text-info">Propuesta</h5>
                    <h2 class="card-text mb-0">
                        {{ estados.propuesta|length }}
                    </h2>
                    <small class="text-muted">Proyectos</small>
                </div>
            </div>
        </div>
        <div>
            <div class="card bg-light h-100">
                <div class="card-body">
                    <h5 class="card-title text-warning">Aprobación</h5>
                    <h2 class="card-text mb-0">
                        {{ estados.aprobado|length }}
                    </h2>
                    <small class="text-muted">Proyectos</small>
                </div>
            </div>
        </div>
        <div>
            <div class="card bg-light h-100">
                <div class="card-body">
                    <h5 class="card-title text-success">En Desarrollo</h5>
                    <h2 class="card-text mb-0">
                        {{ estados.desarrollo|length }}
                    </h2>
                    <small class="text-muted">Proyectos</small>
                </div>
            </div>
        </div>
    </div>
    <div
        class="row"
        style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem"
    >
        <div>
            <div class="card bg-light h-100">
                <div class="card-body">
                    <h5 class="card-title text-primary">Testing</h5>
                    <h2 class="card-text mb-0">{{ estados.testing|length }}</h2>
                    <small class="text-muted">Proyectos</small>
                </div>
            </div>
        </div>
        <div>
            <div class="card bg-light h-100">
                <div class="card-body">
                    <h5 class="card-title text-info">Cierre</h5>
                    <h2 class="card-text mb-0">{{ estados.cierre|length }}</h2>
                    <small class="text-muted">Proyectos</small>
                </div>
            </div>
        </div>
        <div>
            <div class="card bg-light h-100">
                <div class="card-body">
                    <h5 class="card-title text-warning">Evaluación</h5>
                    <h2 class="card-text mb-0">
                        {{ estados.evaluacion|length }}
                    </h2>
                    <small class="text-muted">Proyectos</small>
                </div>
            </div>
        </div>
        <div>
            <div class="card bg-light h-100">
                <div class="card-body">
                    <h5 class="card-title text-success">Finalizados</h5>
                    <h2 class="card-text mb-0">
                        {{ estados.finalizados|length }}
                    </h2>
                    <small class="text-muted">Proyectos</small>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid mt-4">
    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th>Oportunidad</th>
                    <th>Propuesta</th>
                    <th>Aprobación</th>
                    <th>En Desarrollo</th>
                    <th>Testing</th>
                    <th>Cierre</th>
                    <th>Evaluación</th>
                </tr>
            </thead>
            <tbody>
                <tr style="vertical-align: top">
                    <td>
                        {% for proyecto in estados.oportunidad %} {% if
                        proyecto.id != 3 and proyecto.id != 4 %}
                        <div class="card mb-2">
                            <div class="card-body p-2">
                                <h6 class="card-title">
                                    {{ proyecto.nombre }}
                                </h6>
                                <small class="text-muted"
                                    >ID: {{ proyecto.id }}</small
                                >
                            </div>
                        </div>
                        {% endif %} {% endfor %}
                    </td>
                    <td>
                        {% for proyecto in estados.propuesta %}
                        <div class="card mb-2">
                            <div class="card-body p-2">
                                <h6 class="card-title">
                                    {{ proyecto.nombre }}
                                </h6>
                                <small class="text-muted"
                                    >ID: {{ proyecto.id }}</small
                                >
                            </div>
                        </div>
                        {% endfor %}
                    </td>
                    <td>
                        {% for proyecto in estados.aprobado %}
                        <div class="card mb-2">
                            <div class="card-body p-2">
                                <h6 class="card-title">
                                    {{ proyecto.nombre }}
                                </h6>
                                <small class="text-muted"
                                    >ID: {{ proyecto.id }}</small
                                >
                            </div>
                        </div>
                        {% endfor %}
                    </td>
                    <td>
                        {% for proyecto in estados.desarrollo %}
                        <div class="card mb-2">
                            <div class="card-body p-2">
                                <h6 class="card-title">
                                    {{ proyecto.nombre }}
                                </h6>
                                <small class="text-muted"
                                    >ID: {{ proyecto.id }}</small
                                >
                            </div>
                        </div>
                        {% endfor %}
                    </td>
                    <td>
                        {% for proyecto in estados.testing %}
                        <div class="card mb-2">
                            <div class="card-body p-2">
                                <h6 class="card-title">
                                    {{ proyecto.nombre }}
                                </h6>
                                <small class="text-muted"
                                    >ID: {{ proyecto.id }}</small
                                >
                            </div>
                        </div>
                        {% endfor %}
                    </td>
                    <td>
                        {% for proyecto in estados.cierre %}
                        <div class="card mb-2">
                            <div class="card-body p-2">
                                <h6 class="card-title">
                                    {{ proyecto.nombre }}
                                </h6>
                                <small class="text-muted"
                                    >ID: {{ proyecto.id }}</small
                                >
                            </div>
                        </div>
                        {% endfor %}
                    </td>
                    <td>
                        {% for proyecto in estados.evaluacion %}
                        <div class="card mb-2">
                            <div class="card-body p-2">
                                <h6 class="card-title">
                                    {{ proyecto.nombre }}
                                </h6>
                                <small class="text-muted"
                                    >ID: {{ proyecto.id }}</small
                                >
                            </div>
                        </div>
                        {% endfor %}
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
{% endblock %} {% block scripts %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        feather.replace();
        
        // Inicializar tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });

    function openOportunidadModal() {
        // Limpiar formulario
        document.getElementById('nuevaOportunidadForm').reset();
        // Reemplazar iconos de Feather
        setTimeout(() => {
            feather.replace();
        }, 100);
    }

    function submitOportunidad() {
        const form = document.getElementById('nuevaOportunidadForm');
        
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const formData = {
            cuenta: document.getElementById('cuenta').value,
            nombre: document.getElementById('nombre').value,
            descripcion: document.getElementById('descripcion').value,
            impacto: document.getElementById('impacto').value
        };

        // Enviar datos al servidor
        fetch('/api/oportunidades', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('Oportunidad creada exitosamente');
                // Cerrar modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('nuevaOportunidadModal'));
                modal.hide();
                // Recargar página para mostrar la nueva oportunidad
                window.location.reload();
            } else {
                alert('Error al crear oportunidad: ' + (data.message || 'Error desconocido'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al conectar con el servidor');
        });
    }
</script>
{% endblock %}
