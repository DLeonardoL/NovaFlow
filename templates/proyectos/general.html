{% extends "layout.html" %} {% block content %}
<div class="d-flex justify-content-between p-4">
    <h2>Gestión de Proyectos</h2>
    <button
        class="btn btn-primary"
        onclick="openOportunidadModal()"
    >
        <i data-feather="plus"></i> Nueva Oportunidad
    </button>
</div>

<!-- Modal para Nueva Oportunidad -->
<div class="modal" id="nuevaOportunidadModal" style="display: none;">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="border: none; border-radius: 16px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); overflow: hidden;">
            <div class="modal-header" style="background: linear-gradient(135deg, #8B5A9D, #A084B8); border-bottom: 1px solid rgba(255, 255, 255, 0.1); padding: 1.5rem 2rem;">
                <h5 class="modal-title" style="font-size: 1.5rem; font-weight: 600; color: white; margin: 0;">Nueva Oportunidad</h5>
                <button type="button" class="btn-close-custom" onclick="closeOportunidadModal()" style="background: none; border: none; color: white; font-size: 1.5rem; opacity: 0.8; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer;">×</button>
            </div>
            <div class="modal-body" style="background: white; color: #333; padding: 2rem; max-height: 70vh; overflow-y: auto;">
                <div style="display: flex; align-items: center; margin-bottom: 1.5rem; color: #8B5A9D; font-size: 0.9rem;">
                    <button type="button" onclick="closeOportunidadModal()" style="background: none; border: none; color: #8B5A9D; margin-right: 0.5rem; padding: 0; cursor: pointer;">←</button>
                    <span>Volver</span>
                </div>
                
                <form id="nuevaOportunidadForm">
                    <div class="mb-3">
                        <label for="cuenta" class="form-label" style="font-weight: 500; color: #555; margin-bottom: 0.5rem;">Cuenta</label>
                        <select class="form-control" id="cuenta" name="cuenta" required style="border: 1px solid #ddd; border-radius: 8px; padding: 0.75rem; font-size: 0.95rem; width: 100%;">
                            <option value="">Seleccionar cuenta</option>
                            {% for aliado in aliados.values() %}
                            <option value="{{ aliado.id }}">{{ aliado.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="nombre" class="form-label" style="font-weight: 500; color: #555; margin-bottom: 0.5rem;">
                            Nombre 
                            <span class="text-muted" data-bs-toggle="tooltip" data-bs-placement="top" title="Business Problem">
                                <i data-feather="help-circle" style="width: 16px; height: 16px;"></i>
                            </span>
                        </label>
                        <input type="text" class="form-control" id="nombre" name="nombre" required 
                               placeholder="Describe el problema de negocio"
                               style="border: 1px solid #ddd; border-radius: 8px; padding: 0.75rem; font-size: 0.95rem; width: 100%;">
                    </div>
                    
                    <div class="mb-3">
                        <label for="descripcion" class="form-label" style="font-weight: 500; color: #555; margin-bottom: 0.5rem;">
                            Descripción 
                            <span class="text-muted" data-bs-toggle="tooltip" data-bs-placement="top" title="Iniciativa Analítica">
                                <i data-feather="help-circle" style="width: 16px; height: 16px;"></i>
                            </span>
                        </label>
                        <textarea class="form-control" id="descripcion" name="descripcion" rows="3" required
                                  placeholder="Describe la iniciativa analítica propuesta"
                                  style="border: 1px solid #ddd; border-radius: 8px; padding: 0.75rem; font-size: 0.95rem; width: 100%; resize: vertical;"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="impacto" class="form-label" style="font-weight: 500; color: #555; margin-bottom: 0.5rem;">
                            Impacto 
                            <span class="text-muted" data-bs-toggle="tooltip" data-bs-placement="top" title="Impacto de negocio esperado (decisiones)">
                                <i data-feather="help-circle" style="width: 16px; height: 16px;"></i>
                            </span>
                        </label>
                        <textarea class="form-control" id="impacto" name="impacto" rows="3" required
                                  placeholder="Describe el impacto de negocio esperado y las decisiones que se tomarán"
                                  style="border: 1px solid #ddd; border-radius: 8px; padding: 0.75rem; font-size: 0.95rem; width: 100%; resize: vertical;"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="background: white; border-top: 1px solid #eee; padding: 1.5rem 2rem; display: flex; justify-content: flex-end; gap: 1rem;">
                <button type="button" onclick="closeOportunidadModal()" style="background: #6c757d; border: none; border-radius: 8px; padding: 0.75rem 1.5rem; font-weight: 500; color: white; cursor: pointer;">Cancelar</button>
                <button type="button" onclick="submitOportunidad()" style="background: linear-gradient(135deg, #8B5A9D, #A084B8); border: none; border-radius: 8px; padding: 0.75rem 1.5rem; font-weight: 500; color: white; cursor: pointer;">Crear Oportunidad</button>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid px-4">
    <div
        class="row mb-4"
        style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem"
    >
        <div>
            <div class="card bg-light h-100">
                <div class="card-body">
                    <h5 class="card-title text-primary">Oportunidad</h5>
                    <h2 class="card-text mb-0">
                        {{ estados.oportunidad|length }}
                    </h2>
                    <small class="text-muted">Proyectos</small>
                </div>
            </div>
        </div>
        <div>
            <div class="card bg-light h-100">
                <div class="card-body">
                    <h5 class="card-title text-info">Propuesta</h5>
                    <h2 class="card-text mb-0">
                        {{ estados.propuesta|length }}
                    </h2>
                    <small class="text-muted">Proyectos</small>
                </div>
            </div>
        </div>
        <div>
            <div class="card bg-light h-100">
                <div class="card-body">
                    <h5 class="card-title text-warning">Aprobación</h5>
                    <h2 class="card-text mb-0">
                        {{ estados.aprobado|length }}
                    </h2>
                    <small class="text-muted">Proyectos</small>
                </div>
            </div>
        </div>
        <div>
            <div class="card bg-light h-100">
                <div class="card-body">
                    <h5 class="card-title text-success">En Desarrollo</h5>
                    <h2 class="card-text mb-0">
                        {{ estados.desarrollo|length }}
                    </h2>
                    <small class="text-muted">Proyectos</small>
                </div>
            </div>
        </div>
    </div>
    <div
        class="row"
        style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem"
    >
        <div>
            <div class="card bg-light h-100">
                <div class="card-body">
                    <h5 class="card-title text-primary">Testing</h5>
                    <h2 class="card-text mb-0">{{ estados.testing|length }}</h2>
                    <small class="text-muted">Proyectos</small>
                </div>
            </div>
        </div>
        <div>
            <div class="card bg-light h-100">
                <div class="card-body">
                    <h5 class="card-title text-info">Cierre</h5>
                    <h2 class="card-text mb-0">{{ estados.cierre|length }}</h2>
                    <small class="text-muted">Proyectos</small>
                </div>
            </div>
        </div>
        <div>
            <div class="card bg-light h-100">
                <div class="card-body">
                    <h5 class="card-title text-warning">Evaluación</h5>
                    <h2 class="card-text mb-0">
                        {{ estados.evaluacion|length }}
                    </h2>
                    <small class="text-muted">Proyectos</small>
                </div>
            </div>
        </div>
        <div>
            <div class="card bg-light h-100">
                <div class="card-body">
                    <h5 class="card-title text-success">Finalizados</h5>
                    <h2 class="card-text mb-0">
                        {{ estados.finalizados|length }}
                    </h2>
                    <small class="text-muted">Proyectos</small>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid mt-4">
    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th>Oportunidad</th>
                    <th>Propuesta</th>
                    <th>Aprobación</th>
                    <th>En Desarrollo</th>
                    <th>Testing</th>
                    <th>Cierre</th>
                    <th>Evaluación</th>
                </tr>
            </thead>
            <tbody>
                <tr style="vertical-align: top">
                    <td>
                        {% for proyecto in estados.oportunidad %} {% if
                        proyecto.id != 3 and proyecto.id != 4 %}
                        <div class="card mb-2">
                            <div class="card-body p-2">
                                <h6 class="card-title">
                                    {{ proyecto.nombre }}
                                </h6>
                                <small class="text-muted"
                                    >ID: {{ proyecto.id }}</small
                                >
                            </div>
                        </div>
                        {% endif %} {% endfor %}
                    </td>
                    <td>
                        {% for proyecto in estados.propuesta %}
                        <div class="card mb-2">
                            <div class="card-body p-2">
                                <h6 class="card-title">
                                    {{ proyecto.nombre }}
                                </h6>
                                <small class="text-muted"
                                    >ID: {{ proyecto.id }}</small
                                >
                            </div>
                        </div>
                        {% endfor %}
                    </td>
                    <td>
                        {% for proyecto in estados.aprobado %}
                        <div class="card mb-2">
                            <div class="card-body p-2">
                                <h6 class="card-title">
                                    {{ proyecto.nombre }}
                                </h6>
                                <small class="text-muted"
                                    >ID: {{ proyecto.id }}</small
                                >
                            </div>
                        </div>
                        {% endfor %}
                    </td>
                    <td>
                        {% for proyecto in estados.desarrollo %}
                        <div class="card mb-2">
                            <div class="card-body p-2">
                                <h6 class="card-title">
                                    {{ proyecto.nombre }}
                                </h6>
                                <small class="text-muted"
                                    >ID: {{ proyecto.id }}</small
                                >
                            </div>
                        </div>
                        {% endfor %}
                    </td>
                    <td>
                        {% for proyecto in estados.testing %}
                        <div class="card mb-2">
                            <div class="card-body p-2">
                                <h6 class="card-title">
                                    {{ proyecto.nombre }}
                                </h6>
                                <small class="text-muted"
                                    >ID: {{ proyecto.id }}</small
                                >
                            </div>
                        </div>
                        {% endfor %}
                    </td>
                    <td>
                        {% for proyecto in estados.cierre %}
                        <div class="card mb-2">
                            <div class="card-body p-2">
                                <h6 class="card-title">
                                    {{ proyecto.nombre }}
                                </h6>
                                <small class="text-muted"
                                    >ID: {{ proyecto.id }}</small
                                >
                            </div>
                        </div>
                        {% endfor %}
                    </td>
                    <td>
                        {% for proyecto in estados.evaluacion %}
                        <div class="card mb-2">
                            <div class="card-body p-2">
                                <h6 class="card-title">
                                    {{ proyecto.nombre }}
                                </h6>
                                <small class="text-muted"
                                    >ID: {{ proyecto.id }}</small
                                >
                            </div>
                        </div>
                        {% endfor %}
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
{% endblock %} {% block scripts %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        feather.replace();
    });

    function openOportunidadModal() {
        const modal = document.getElementById('nuevaOportunidadModal');
        if (modal) {
            // Limpiar formulario
            const form = document.getElementById('nuevaOportunidadForm');
            if (form) {
                form.reset();
            }
            
            // Mostrar modal
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.6)';
            modal.style.zIndex = '1055';
            
            // Reemplazar iconos de Feather
            setTimeout(() => {
                feather.replace();
            }, 100);
        }
    }

    function closeOportunidadModal() {
        const modal = document.getElementById('nuevaOportunidadModal');
        if (modal) {
            modal.style.display = 'none';
        }
    }

    function submitOportunidad() {
        const form = document.getElementById('nuevaOportunidadForm');
        
        if (!form || !form.checkValidity()) {
            if (form) form.reportValidity();
            return;
        }

        const cuentaElement = document.getElementById('cuenta');
        const nombreElement = document.getElementById('nombre');
        const descripcionElement = document.getElementById('descripcion');
        const impactoElement = document.getElementById('impacto');

        if (!cuentaElement || !nombreElement || !descripcionElement || !impactoElement) {
            alert('Error: No se pudieron encontrar todos los campos del formulario');
            return;
        }

        const formData = {
            cuenta: cuentaElement.value,
            nombre: nombreElement.value,
            descripcion: descripcionElement.value,
            impacto: impactoElement.value
        };

        // Enviar datos al servidor
        fetch('/api/oportunidades', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('Oportunidad creada exitosamente');
                closeOportunidadModal();
                // Recargar página para mostrar la nueva oportunidad
                window.location.reload();
            } else {
                alert('Error al crear oportunidad: ' + (data.message || 'Error desconocido'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al conectar con el servidor');
        });
    }

    // Cerrar modal al hacer click en el fondo
    document.addEventListener('click', function(e) {
        const modal = document.getElementById('nuevaOportunidadModal');
        if (e.target === modal) {
            closeOportunidadModal();
        }
    });
</script>
{% endblock %}
