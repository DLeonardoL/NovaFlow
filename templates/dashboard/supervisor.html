
{% extends "layout.html" %}

{% block content %}
<div class="dashboard-container">
    <!-- Header -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <h3 style="margin: 0; color: #333; font-weight: 600;">Gesti√≥n de Proyectos</h3>
        <button type="button" class="btn" onclick="openOportunidadModal()" style="background: #00BCD4; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 500; display: flex; align-items: center; gap: 0.5rem;">
            <span style="font-size: 1.2rem;">+</span>
            Nueva Oportunidad
        </button>
    </div>

    <!-- Kanban Board - Primera fila -->
    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.5rem; margin-bottom: 2rem;">
        <!-- Oportunidad -->
        <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div style="color: #00BCD4; font-weight: 600; margin-bottom: 1rem;">Oportunidad</div>
            <div style="font-size: 3rem; font-weight: bold; color: #333; margin-bottom: 0.5rem;">{{ estados.oportunidad|length }}</div>
            <div style="color: #999; font-size: 0.9rem;">Proyectos</div>
        </div>

        <!-- Propuesta -->
        <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div style="color: #666; font-weight: 600; margin-bottom: 1rem;">Propuesta</div>
            <div style="font-size: 3rem; font-weight: bold; color: #333; margin-bottom: 0.5rem;">{{ estados.propuesta|length }}</div>
            <div style="color: #999; font-size: 0.9rem;">Proyectos</div>
        </div>

        <!-- Aprobaci√≥n -->
        <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div style="color: #FFA726; font-weight: 600; margin-bottom: 1rem;">Aprobaci√≥n</div>
            <div style="font-size: 3rem; font-weight: bold; color: #333; margin-bottom: 0.5rem;">{{ estados.aprobacion|length }}</div>
            <div style="color: #999; font-size: 0.9rem;">Proyectos</div>
        </div>

        <!-- En Desarrollo -->
        <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div style="color: #66BB6A; font-weight: 600; margin-bottom: 1rem;">En Desarrollo</div>
            <div style="font-size: 3rem; font-weight: bold; color: #333; margin-bottom: 0.5rem;">{{ estados.desarrollo|length }}</div>
            <div style="color: #999; font-size: 0.9rem;">Proyectos</div>
        </div>
    </div>

    <!-- Kanban Board - Segunda fila -->
    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.5rem; margin-bottom: 2rem;">
        <!-- Testing -->
        <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div style="color: #00BCD4; font-weight: 600; margin-bottom: 1rem;">Testing</div>
            <div style="font-size: 3rem; font-weight: bold; color: #333; margin-bottom: 0.5rem;">{{ estados.testing|length }}</div>
            <div style="color: #999; font-size: 0.9rem;">Proyectos</div>
        </div>

        <!-- Cierre -->
        <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div style="color: #666; font-weight: 600; margin-bottom: 1rem;">Cierre</div>
            <div style="font-size: 3rem; font-weight: bold; color: #333; margin-bottom: 0.5rem;">{{ estados.cierre|length }}</div>
            <div style="color: #999; font-size: 0.9rem;">Proyectos</div>
        </div>

        <!-- Evaluaci√≥n -->
        <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div style="color: #FFA726; font-weight: 600; margin-bottom: 1rem;">Evaluaci√≥n</div>
            <div style="font-size: 3rem; font-weight: bold; color: #333; margin-bottom: 0.5rem;">{{ estados.evaluacion|length }}</div>
            <div style="color: #999; font-size: 0.9rem;">Proyectos</div>
        </div>

        <!-- Finalizados -->
        <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div style="color: #66BB6A; font-weight: 600; margin-bottom: 1rem;">Finalizados</div>
            <div style="font-size: 3rem; font-weight: bold; color: #333; margin-bottom: 0.5rem;">{{ estados.finalizados|length }}</div>
            <div style="color: #999; font-size: 0.9rem;">Proyectos</div>
        </div>
    </div>

    <!-- Pipeline de Proyectos -->
    <div style="display: flex; gap: 1rem; margin-bottom: 2rem; overflow-x: auto; padding-bottom: 1rem;">
        {% set etapas_orden = ['Oportunidad', 'Propuesta', 'Aprobaci√≥n', 'En Desarrollo', 'Testing', 'Cierre', 'Evaluaci√≥n'] %}
        {% for etapa in etapas_orden %}
            <div style="min-width: 200px; background: #f8f9fa; border-radius: 8px; padding: 1rem;">
                <h6 style="margin: 0 0 1rem 0; color: #666; font-weight: 600;">{{ etapa }}</h6>
                {% if etapa == 'Propuesta' %}
                    {% for proyecto in estados.propuesta %}
                        <div style="background: white; border-radius: 6px; padding: 0.75rem; margin-bottom: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="font-weight: 500; margin-bottom: 0.25rem;">{{ proyecto.nombre }}</div>
                            <div style="font-size: 0.8rem; color: #666;">ID: {{ proyecto.id }}</div>
                        </div>
                    {% endfor %}
                {% elif etapa == 'Cierre' %}
                    {% for proyecto in estados.cierre %}
                        <div style="background: white; border-radius: 6px; padding: 0.75rem; margin-bottom: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="font-weight: 500; margin-bottom: 0.25rem;">{{ proyecto.nombre }}</div>
                            <div style="font-size: 0.8rem; color: #666;">ID: {{ proyecto.id }}</div>
                        </div>
                    {% endfor %}
                {% endif %}
            </div>
        {% endfor %}
    </div>
</div>

<!-- Modal de Nueva Oportunidad -->
<div id="nuevaOportunidadModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 9999;">
    <div class="modal-dialog" style="max-width: 600px; width: 90%; margin: 1.75rem auto;">
        <div class="modal-content" style="border: none; border-radius: 12px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); overflow: hidden;">
            <div class="modal-header" style="background: #8B5A9D; border-bottom: none; padding: 1.25rem 1.5rem; position: relative;">
                <h5 class="modal-title" style="font-size: 1.125rem; font-weight: 600; color: white; margin: 0;">Nueva Oportunidad</h5>
                <button type="button" class="btn-close-custom" onclick="closeOportunidadModal()" style="background: none; border: none; color: white; font-size: 1.5rem; opacity: 1; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; position: absolute; right: 1.5rem; top: 50%; transform: translateY(-50%);">√ó</button>
            </div>
            <div class="modal-body" style="background: white; color: #333; padding: 1.5rem; max-height: 70vh; overflow-y: auto;">
                <div style="display: flex; align-items: center; margin-bottom: 1rem; color: #8B5A9D; font-size: 0.875rem; cursor: pointer;" onclick="closeOportunidadModal()">
                    <span style="margin-right: 0.5rem;">‚Üê</span>
                    <span>Volver</span>
                </div>
                
                <form id="nuevaOportunidadForm">
                    <div class="form-group" style="margin-bottom: 1.25rem;">
                        <label for="cuenta" class="form-label" style="font-weight: 500; color: #555; margin-bottom: 0.5rem;">Cuenta</label>
                        <select class="form-control" id="cuenta" name="cuenta" required style="border: 1px solid #ddd; border-radius: 8px; padding: 0.75rem; font-size: 0.95rem; width: 100%; background-color: #f8f9fa;">
                            <option value="">Seleccionar cuenta...</option>
                            <option value="cliente_1">Banco Nacional S.A.</option>
                            <option value="cliente_2">Corporaci√≥n Minera del Norte</option>
                            <option value="cliente_3">Industrias Alimentarias del Sur</option>
                            <option value="cliente_4">Telecomunicaciones Globales</option>
                            <option value="cliente_5">Energ√≠a Renovable Colombia</option>
                            <option value="cliente_6">Retail Fashion Group</option>
                            <option value="cliente_7">Farmaceutica Nacional</option>
                            <option value="cliente_8">Constructora Metropolitan</option>
                            <option value="cliente_9">Seguros y Fianzas del Pac√≠fico</option>
                            <option value="cliente_10">Universidad Tecnol√≥gica Nacional</option>
                        </select>
                    </div>

                    <div class="form-group" style="margin-bottom: 1.25rem;">
                        <label for="nombre" class="form-label" style="font-weight: 500; color: #555; margin-bottom: 0.5rem;">
                            Caso de uso 
                            <span style="color: #666; font-size: 0.8rem; margin-left: 0.5rem;" title="Nombre (Business problem)">üí¨ Nombre (Business problem)</span>
                        </label>
                        <input type="text" class="form-control" id="nombre" name="nombre" placeholder="Ingrese el nombre del caso de uso..." style="border: 1px solid #ddd; border-radius: 8px; padding: 0.75rem; font-size: 0.95rem; width: 100%;">
                    </div>

                    <div class="form-group" style="margin-bottom: 1.25rem;">
                        <label for="descripcion" class="form-label" style="font-weight: 500; color: #555; margin-bottom: 0.5rem;">
                            Descripci√≥n 
                            <span style="color: #666; font-size: 0.8rem; margin-left: 0.5rem;" title="Iniciativa anal√≠tica">üí¨ Iniciativa anal√≠tica</span>
                        </label>
                        <textarea class="form-control" id="descripcion" name="descripcion" rows="3" placeholder="Describa la iniciativa anal√≠tica..." style="border: 1px solid #ddd; border-radius: 8px; padding: 0.75rem; font-size: 0.95rem; width: 100%; resize: vertical;"></textarea>
                    </div>

                    <div class="form-group" style="margin-bottom: 1.5rem;">
                        <label for="impacto" class="form-label" style="font-weight: 500; color: #555; margin-bottom: 0.5rem;">
                            Impacto 
                            <span style="color: #666; font-size: 0.8rem; margin-left: 0.5rem;" title="Impacto de negocio esperado (decisiones)">üí¨ Impacto de negocio esperado (decisiones)</span>
                        </label>
                        <textarea class="form-control" id="impacto" name="impacto" rows="3" placeholder="Describa el impacto esperado en el negocio..." style="border: 1px solid #ddd; border-radius: 8px; padding: 0.75rem; font-size: 0.95rem; width: 100%; resize: vertical;"></textarea>
                    </div>

                    <div class="form-actions" style="display: flex; justify-content: flex-end; gap: 1rem; padding-top: 1rem; border-top: 1px solid #eee;">
                        <button type="button" onclick="closeOportunidadModal()" style="background: #f8f9fa; color: #666; border: 1px solid #ddd; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 500; cursor: pointer;">Cancelar</button>
                        <button type="submit" style="background: #8B5A9D; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 500; cursor: pointer;">Crear Oportunidad</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function openOportunidadModal() {
    document.getElementById('nuevaOportunidadModal').style.display = 'block';
}

function closeOportunidadModal() {
    document.getElementById('nuevaOportunidadModal').style.display = 'none';
    document.getElementById('nuevaOportunidadForm').reset();
}

// Env√≠o del formulario
document.getElementById('nuevaOportunidadForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData);
    
    fetch('/api/oportunidades', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.status === 'success') {
            alert('Oportunidad creada exitosamente');
            closeOportunidadModal();
            location.reload();
        } else {
            alert('Error al crear oportunidad: ' + result.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al procesar la solicitud');
    });
});

// Cerrar modal al hacer click fuera
document.getElementById('nuevaOportunidadModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeOportunidadModal();
    }
});
</script>
{% endblock %}
