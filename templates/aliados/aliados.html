{% extends "layout.html" %}

{% block content %}
<div class="container-fluid">
    <!-- Header with action buttons -->
    <div class="dashboard-section-title">
        <h4>Gestión de Aliados</h4>
        <div class="action-buttons">
            <button type="button" class="action-button" data-bs-toggle="modal" data-bs-target="#addAliadoModal">
                <i data-feather="plus"></i>
            </button>
            <button type="button" class="action-button" data-bs-toggle="modal" data-bs-target="#importAliadosModal">
                <i data-feather="upload"></i>
            </button>
            <button type="button" class="action-button" data-bs-toggle="modal" data-bs-target="#exportAliadosModal">
                <i data-feather="download"></i>
            </button>
        </div>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <form id="filterForm" class="filter-form">
                <div class="filter-row">
                    <div class="filter-group">
                        <label class="form-label">Nombre</label>
                        <select class="form-select" name="nombre">
                            <option value="">Todos</option>
                            {% for aliado in aliados %}
                            <option value="{{ aliado.nombre }}">{{ aliado.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="form-label">Industria</label>
                        <select class="form-select" name="industria">
                            <option value="">Todas</option>
                            <option value="Tecnología">Tecnología</option>
                            <option value="Finanzas">Finanzas</option>
                            <option value="Manufactura">Manufactura</option>
                            <option value="Servicios">Servicios</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="form-label">Estado</label>
                        <select class="form-select" name="estado">
                            <option value="">Todos</option>
                            <option value="activo">Activo</option>
                            <option value="inactivo">Inactivo</option>
                            <option value="pendiente">Pendiente</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="form-label">Región</label>
                        <select class="form-select" name="region">
                            <option value="">Todas</option>
                            <option value="Norte">Norte</option>
                            <option value="Sur">Sur</option>
                            <option value="Este">Este</option>
                            <option value="Oeste">Oeste</option>
                            <option value="Centro">Centro</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="form-label">Subregión</label>
                        <select class="form-select" name="subregion">
                            <option value="">Todas</option>
                            <option value="Noreste">Noreste</option>
                            <option value="Noroeste">Noroeste</option>
                            <option value="Sureste">Sureste</option>
                            <option value="Suroeste">Suroeste</option>
                            <option value="Centro-Norte">Centro-Norte</option>
                            <option value="Centro-Sur">Centro-Sur</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="form-label">País</label>
                        <select class="form-select" name="pais">
                            <option value="">Todos</option>
                            <option value="México">México</option>
                            <option value="Estados Unidos">Estados Unidos</option>
                            <option value="Colombia">Colombia</option>
                            <option value="Argentina">Argentina</option>
                            <option value="Chile">Chile</option>
                        </select>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Aliados Table -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0" id="aliadosTable">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Industria</th>
                            <th>Estado</th>
                            <th>Región</th>
                            <th>Subregión</th>
                            <th>País</th>
                            <th>Sede</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for aliado in aliados %}
                        <tr data-nombre="{{ aliado.nombre }}" data-industria="{{ aliado.industria }}" data-region="{{ aliado.region }}">
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="avatar-circle me-2">{{ aliado.nombre[0] }}</div>
                                    <div>{{ aliado.nombre }}</div>
                                </div>
                            </td>
                            <td>{{ aliado.industria }}</td>
                            <td>
                                <span class="badge {% if aliado.id % 3 == 0 %}bg-warning{% elif aliado.id % 2 == 0 %}bg-success{% else %}bg-primary{% endif %}">
                                    {% if aliado.id % 3 == 0 %}Pendiente
                                    {% elif aliado.id % 2 == 0 %}Activo
                                    {% else %}Nuevo{% endif %}
                                </span>
                            </td>
                            <td>{{ aliado.region }}</td>
                            <td>
                                {% if aliado.region == 'Norte' %}
                                    {% if aliado.id % 2 == 0 %}Noreste{% else %}Noroeste{% endif %}
                                {% elif aliado.region == 'Sur' %}
                                    {% if aliado.id % 2 == 0 %}Sureste{% else %}Suroeste{% endif %}
                                {% else %}
                                    Centro-Norte
                                {% endif %}
                            </td>
                            <td>
                                {% if aliado.industria == 'Tecnología' %}México
                                {% elif aliado.industria == 'Finanzas' %}Estados Unidos
                                {% elif aliado.industria == 'Manufactura' %}Colombia
                                {% else %}México{% endif %}
                            </td>
                            <td>
                                {% if aliado.region == 'Norte' %}Sede Norte
                                {% elif aliado.region == 'Sur' %}Sede Sur
                                {% elif aliado.region == 'Este' %}Sede Este
                                {% elif aliado.region == 'Oeste' %}Sede Oeste
                                {% else %}Sede Central{% endif %}
                            </td>
                            <td>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-sm btn-icon" title="Editar">
                                        <i data-feather="edit-2"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-icon" title="Ver detalles">
                                        <i data-feather="eye"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-icon text-danger" title="Eliminar">
                                        <i data-feather="trash-2"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal Añadir Aliado -->
<div class="modal fade" id="addAliadoModal" tabindex="-1" aria-labelledby="addAliadoModalLabel" aria-hidden="true" style="display: none;">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addAliadoModalLabel">Gestión de Aliados</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Selector de tipo de formulario -->
                <div class="form-type-selector mb-4">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-option" onclick="selectFormType('organizacion')">
                                <div class="form-option-icon">
                                    <i data-feather="building-2" class="text-primary"></i>
                                </div>
                                <div class="form-option-content">
                                    <h5 class="form-option-title">Crear Organización</h5>
                                    <p class="form-option-desc">Registrar una nueva organización aliada</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-option" onclick="selectFormType('sede')">
                                <div class="form-option-icon">
                                    <i data-feather="map-pin" class="text-success"></i>
                                </div>
                                <div class="form-option-content">
                                    <h5 class="form-option-title">Agregar Sede</h5>
                                    <p class="form-option-desc">Añadir una nueva sede a organización existente</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Formulario Crear Organización -->
                <div id="formOrganizacion" class="form-container" style="display: none;">
                    <h6 class="form-section-title">Datos de la Organización</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="orgNombre" class="form-label">Nombre</label>
                                <input type="text" class="form-control" id="orgNombre" placeholder="Nombre de la organización">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="orgIndustria" class="form-label">Industria</label>
                                <select class="form-select" id="orgIndustria">
                                    <option value="">Seleccionar industria...</option>
                                    <option value="Tecnología">Tecnología</option>
                                    <option value="Finanzas">Finanzas</option>
                                    <option value="Manufactura">Manufactura</option>
                                    <option value="Servicios">Servicios</option>
                                    <option value="Salud">Salud</option>
                                    <option value="Educación">Educación</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="orgEstado" class="form-label">Estado</label>
                                <select class="form-select" id="orgEstado">
                                    <option value="">Seleccionar estado...</option>
                                    <option value="activo">Activo</option>
                                    <option value="inactivo">Inactivo</option>
                                    <option value="pendiente">Pendiente</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="orgContacto" class="form-label">Contacto Principal</label>
                                <input type="text" class="form-control" id="orgContacto" placeholder="Número de contacto principal">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="orgTamano" class="form-label">Tamaño</label>
                                <select class="form-select" id="orgTamano">
                                    <option value="">Seleccionar tamaño...</option>
                                    <option value="pequeña">Pequeña</option>
                                    <option value="mediana">Mediana</option>
                                    <option value="grande">Grande</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="orgEmpleados" class="form-label">Empleados</label>
                                <input type="number" class="form-control" id="orgEmpleados" placeholder="Cantidad de empleados" min="1">
                            </div>
                        </div>
                    </div>

                    <h6 class="form-section-title">Datos de la Sede</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="orgRegion" class="form-label">Región</label>
                                <select class="form-select" id="orgRegion">
                                    <option value="">Seleccionar región...</option>
                                    <option value="Norte">Norte</option>
                                    <option value="Sur">Sur</option>
                                    <option value="Este">Este</option>
                                    <option value="Oeste">Oeste</option>
                                    <option value="Centro">Centro</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="orgDireccion" class="form-label">Dirección</label>
                                <input type="text" class="form-control" id="orgDireccion" placeholder="Dirección completa">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="orgCiudad" class="form-label">Ciudad</label>
                                <input type="text" class="form-control" id="orgCiudad" placeholder="Ciudad">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="orgCodigoPostal" class="form-label">Código Postal</label>
                                <input type="text" class="form-control" id="orgCodigoPostal" placeholder="Código postal">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="orgPais" class="form-label">País</label>
                                <input type="text" class="form-control" id="orgPais" placeholder="País">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Formulario Agregar Sede -->
                <div id="formSede" class="form-container" style="display: none;">
                    <h6 class="form-section-title">Información de la Sede</h6>
                    <div class="mb-3">
                        <label for="sedeOrganizacion" class="form-label">Organización</label>
                        <select class="form-select" id="sedeOrganizacion">
                            <option value="">Seleccionar organización...</option>
                            {% for aliado in aliados %}
                            <option value="{{ aliado.id }}">{{ aliado.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="sedeRegion" class="form-label">Región</label>
                                <select class="form-select" id="sedeRegion">
                                    <option value="">Seleccionar región...</option>
                                    <option value="Norte">Norte</option>
                                    <option value="Sur">Sur</option>
                                    <option value="Este">Este</option>
                                    <option value="Oeste">Oeste</option>
                                    <option value="Centro">Centro</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="sedeDireccion" class="form-label">Dirección</label>
                                <input type="text" class="form-control" id="sedeDireccion" placeholder="Dirección completa">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="sedeCiudad" class="form-label">Ciudad</label>
                                <input type="text" class="form-control" id="sedeCiudad" placeholder="Ciudad">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="sedeCodigoPostal" class="form-label">Código Postal</label>
                                <input type="text" class="form-control" id="sedeCodigoPostal" placeholder="Código postal">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="sedePais" class="form-label">País</label>
                                <input type="text" class="form-control" id="sedePais" placeholder="País">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="submitForm()">Guardar</button>
            </div>
        </div>
    </div>
</div>

<style>
.dashboard-section-title {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.action-buttons {
    display: flex;
    gap: 0.5rem;
}

.action-button {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    border-radius: 8px;
    padding: 8px 12px;
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
}

.action-button:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.filter-form {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 1.5rem;
}

.filter-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
}

.filter-group {
    display: flex;
    flex-direction: column;
}

.filter-actions {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #dee2e6;
}

.avatar-circle {
    width: 32px;
    height: 32px;
    background-color: var(--primary);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
}

.btn-icon {
    width: 32px;
    height: 32px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid #dee2e6;
    background: white;
    border-radius: 6px;
}

.btn-icon:hover {
    background: #f8f9fa;
}

.form-type-selector {
    margin-bottom: 2rem;
}

.form-option {
    border: 2px solid #e9ecef;
    border-radius: 12px;
    padding: 1.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
    height: 100%;
    display: flex;
    align-items: center;
}

.form-option:hover {
    border-color: #667eea;
    background: #f8f9ff;
}

.form-option.active {
    border-color: #667eea;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.form-option-icon {
    margin-right: 1rem;
    font-size: 1.5rem;
}

.form-option-title {
    margin: 0 0 0.25rem 0;
    font-size: 1.1rem;
    font-weight: 600;
}

.form-option-desc {
    margin: 0;
    font-size: 0.9rem;
    opacity: 0.8;
}

.form-container {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 1.5rem;
}

.form-section-title {
    color: #667eea;
    font-weight: 600;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #e9ecef;
}
</style>

<script>
// Variables globales
let selectedFormType = null;

// Inicialización cuando el DOM esté listo
document.addEventListener('DOMContentLoaded', function() {
    if (typeof feather !== 'undefined') {
        feather.replace();
    }

    initializeFilters();
});

// Función para seleccionar tipo de formulario
function selectFormType(type) {
    selectedFormType = type;

    // Remover clase active de todas las opciones
    document.querySelectorAll('.form-option').forEach(option => {
        option.classList.remove('active');
    });

    // Agregar clase active a la opción seleccionada
    event.currentTarget.classList.add('active');

    // Ocultar todos los formularios
    document.getElementById('formOrganizacion').style.display = 'none';
    document.getElementById('formSede').style.display = 'none';

    // Mostrar el formulario correspondiente
    if (type === 'organizacion') {
        document.getElementById('formOrganizacion').style.display = 'block';
    } else if (type === 'sede') {
        document.getElementById('formSede').style.display = 'block';
    }
}

// Función para enviar formulario
function submitForm() {
    if (!selectedFormType) {
        alert('Por favor selecciona un tipo de formulario');
        return;
    }

    let formData = {
        tipo: selectedFormType
    };

    if (selectedFormType === 'organizacion') {
        formData = {
            ...formData,
            nombre: document.getElementById('orgNombre').value,
            industria: document.getElementById('orgIndustria').value,
            estado: document.getElementById('orgEstado').value,
            contacto: document.getElementById('orgContacto').value,
            tamano: document.getElementById('orgTamano').value,
            empleados: document.getElementById('orgEmpleados').value,
            region: document.getElementById('orgRegion').value,
            direccion: document.getElementById('orgDireccion').value,
            ciudad: document.getElementById('orgCiudad').value,
            codigo_postal: document.getElementById('orgCodigoPostal').value,
            pais: document.getElementById('orgPais').value
        };
    } else if (selectedFormType === 'sede') {
        formData = {
            ...formData,
            organizacion: document.getElementById('sedeOrganizacion').value,
            region: document.getElementById('sedeRegion').value,
            direccion: document.getElementById('sedeDireccion').value,
            ciudad: document.getElementById('sedeCiudad').value,
            codigo_postal: document.getElementById('sedeCodigoPostal').value,
            pais: document.getElementById('sedePais').value
        };
    }

    console.log('Datos del formulario:', formData);

    // Enviar datos al servidor (simulado)
    fetch('/api/aliados', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert('Datos guardados exitosamente');
            // Cerrar modal y recargar página
            const modal = bootstrap.Modal.getInstance(document.getElementById('addAliadoModal'));
            modal.hide();
            location.reload();
        } else {
            alert('Error al guardar: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al enviar los datos');
    });
}

// Función para inicializar filtros
function initializeFilters() {
    const filterForm = document.getElementById('filterForm');
    const table = document.getElementById('aliadosTable');
    
    if (!filterForm || !table) {
        console.error('Filter form or table not found');
        return;
    }
    
    const tableRows = table.querySelectorAll('tbody tr');
    
    // Poblar dinámicamente las opciones del filtro de nombre
    populateNameFilter();
    
    // Agregar event listeners a todos los campos de filtro
    const filterInputs = filterForm.querySelectorAll('select');
    filterInputs.forEach(input => {
        if (input && typeof input.addEventListener === 'function') {
            input.addEventListener('change', applyFilters);
        }
    });

    function populateNameFilter() {
        const nameSelect = filterForm.querySelector('[name="nombre"]');
        if (!nameSelect) return;
        
        // Limpiar opciones existentes excepto "Todos"
        nameSelect.innerHTML = '<option value="">Todos</option>';
        
        // Extraer nombres únicos de las filas de la tabla
        const uniqueNames = new Set();
        tableRows.forEach(row => {
            if (row.cells && row.cells[0]) {
                const nameCell = row.cells[0].querySelector('div:last-child');
                if (nameCell) {
                    const name = nameCell.textContent.trim();
                    if (name) uniqueNames.add(name);
                }
            }
        });
        
        // Agregar opciones al select
        Array.from(uniqueNames).sort().forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            nameSelect.appendChild(option);
        });
    }

    function applyFilters() {
        const nameFilter = filterForm.querySelector('[name="nombre"]');
        const industriaFilter = filterForm.querySelector('[name="industria"]');
        const estadoFilter = filterForm.querySelector('[name="estado"]');
        const regionFilter = filterForm.querySelector('[name="region"]');
        const subregionFilter = filterForm.querySelector('[name="subregion"]');
        const paisFilter = filterForm.querySelector('[name="pais"]');
        
        const filters = {
            nombre: nameFilter ? nameFilter.value.toLowerCase() : '',
            industria: industriaFilter ? industriaFilter.value.toLowerCase() : '',
            estado: estadoFilter ? estadoFilter.value.toLowerCase() : '',
            region: regionFilter ? regionFilter.value.toLowerCase() : '',
            subregion: subregionFilter ? subregionFilter.value.toLowerCase() : '',
            pais: paisFilter ? paisFilter.value.toLowerCase() : ''
        };

        let visibleCount = 0;
        
        tableRows.forEach(row => {
            if (!row.cells || row.cells.length < 7) return;
            
            // Extraer datos de la fila de manera más robusta
            const nameCell = row.cells[0].querySelector('div:last-child');
            const industriaCell = row.cells[1];
            const estadoCell = row.cells[2].querySelector('.badge');
            const regionCell = row.cells[3];
            const subregionCell = row.cells[4];
            const paisCell = row.cells[5];
            
            const rowData = {
                nombre: nameCell ? nameCell.textContent.trim().toLowerCase() : '',
                industria: industriaCell ? industriaCell.textContent.trim().toLowerCase() : '',
                estado: estadoCell ? estadoCell.textContent.trim().toLowerCase() : '',
                region: regionCell ? regionCell.textContent.trim().toLowerCase() : '',
                subregion: subregionCell ? subregionCell.textContent.trim().toLowerCase() : '',
                pais: paisCell ? paisCell.textContent.trim().toLowerCase() : ''
            };

            let showRow = true;

            // Aplicar cada filtro
            Object.keys(filters).forEach(key => {
                if (filters[key] && !rowData[key].includes(filters[key])) {
                    showRow = false;
                }
            });

            // Mostrar u ocultar la fila
            if (showRow) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });

        console.log(`Mostrando ${visibleCount} de ${tableRows.length} aliados`);
    }
}
</script>

{% endblock %}